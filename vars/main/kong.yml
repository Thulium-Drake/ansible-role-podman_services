---
# Kong API Gateway container definitions
podman_service_containers_kong:
  kong:
    postgresql:
      image: "docker.io/library/postgres:16-alpine"
      network:
        - 'kong-backend.network'
      healthcheck: "pg_isready -d {{ kong_postgres_db }} -U {{ kong_postgres_user }}"
      volumes:
        - "{{ service['name'] }}-postgresql-data:/var/lib/postgresql/data:Z"
      env:
        POSTGRES_PASSWORD: "{{ kong_postgres_password }}"
        POSTGRES_USER: "{{ kong_postgres_user }}"
        POSTGRES_DB: "{{ kong_postgres_db }}"
    
    kong-migrations:
      image: "docker.io/library/kong:{{ kong_version }}"
      command: 'kong migrations bootstrap'
      network:
        - 'kong-backend.network'
      env:
        KONG_DATABASE: "{{ kong_database }}"
        KONG_PG_DATABASE: "{{ kong_pg_database }}"
        KONG_PG_HOST: 'kong-postgresql'
        KONG_PG_USER: "{{ kong_pg_user }}"
        KONG_PG_PASSWORD: "{{ kong_pg_password }}"
      depends_on:
        - 'postgresql'
      restart: 'on-failure'
    
    kong-migrations-up:
      image: "docker.io/library/kong:{{ kong_version }}"
      command: 'kong migrations up && kong migrations finish'
      network:
        - 'kong-backend.network'
      env:
        KONG_DATABASE: "{{ kong_database }}"
        KONG_PG_DATABASE: "{{ kong_pg_database }}"
        KONG_PG_HOST: 'kong-postgresql'
        KONG_PG_USER: "{{ kong_pg_user }}"
        KONG_PG_PASSWORD: "{{ kong_pg_password }}"
      depends_on:
        - 'postgresql'
      restart: 'on-failure'
    
    kong:
      image: "docker.io/library/kong:{{ kong_version }}"
      user: 'kong'
      network:
        - 'kong-backend.network'
      ports:
        - "{{ kong_proxy_port }}:8000/tcp"
        - "{{ kong_proxy_ssl_port }}:8443/tcp"
        - "{{ kong_admin_port }}:8001/tcp"
        - "{{ kong_admin_ssl_port }}:8444/tcp"
        - "{{ kong_admin_gui_port }}:8002/tcp"
      volumes:
        - "{{ service['name'] }}-data:/var/run/kong:Z"
      env:
        KONG_DATABASE: "{{ kong_database }}"
        KONG_PG_DATABASE: "{{ kong_pg_database }}"
        KONG_PG_HOST: 'kong-postgresql'
        KONG_PG_USER: "{{ kong_pg_user }}"
        KONG_PG_PASSWORD: "{{ kong_pg_password }}"
        KONG_ADMIN_ACCESS_LOG: '/dev/stdout'
        KONG_ADMIN_ERROR_LOG: '/dev/stderr'
        KONG_PROXY_LISTEN: '0.0.0.0:8000'
        KONG_ADMIN_LISTEN: '0.0.0.0:8001'
        KONG_ADMIN_GUI_LISTEN: '0.0.0.0:8002'
        KONG_PROXY_ACCESS_LOG: '/dev/stdout'
        KONG_PROXY_ERROR_LOG: '/dev/stderr'
        KONG_PREFIX: "{{ kong_prefix }}"
        KONG_DECLARATIVE_CONFIG: "{{ kong_declarative_config }}"
      depends_on:
        - 'postgresql'
        - 'kong-migrations'
        - 'kong-migrations-up'
      healthcheck: 'kong health'
